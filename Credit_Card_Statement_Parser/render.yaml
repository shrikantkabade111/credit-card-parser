# render.yaml
services:
  # 1. The Redis Cache (Private Service)
  - type: pserv 
    name: redis
    image:
      url: redis:7-alpine # From your docker-compose.yml
    autoDeploy: false
    disk:
      name: redis-data
      mountPath: /data
      sizeGB: 1

  # 2. The FastAPI Web API (Web Service)
  - type: web
    name: api
    runtime: docker
    dockerfilePath: ./Dockerfile
    dockerContext: .
    # This command is from your docker-compose.yml but without --reload
    dockerCommand: uvicorn app.main:app --host 0.0.0.0 --port 8000
    autoDeploy: true # Redeploy on push to 'main'
    envVars:
      - key: CELERY_BROKER_URL
        fromService:
          type: pserv
          name: redis
          property: internalUrl # Use Render's internal URL
      - key: CELERY_RESULT_BACKEND
        fromService:
          type: pserv
          name: redis
          property: internalUrl # Use Render's internal URL
      # --- IMPORTANT: Add your secret key in the Render UI ---
      - key: MASTER_API_KEY
        sync: false # Tells Render this is a secret
      - key: TESSERACT_OCR_ENABLED
        value: true
      - key: LOG_LEVEL
        value: INFO
      - key: DEBUG
        value: false # Production should be false

  # 3. The Celery Worker
  - type: worker
    name: worker
    runtime: docker
    dockerfilePath: ./Dockerfile
    dockerContext: .
    dockerCommand: celery -A app.tasks:celery_app worker --loglevel=info --concurrency=2 # From your docker-compose.yml
    autoDeploy: true # Redeploy on push to 'main'
    envVars:
      - key: CELERY_BROKER_URL
        fromService:
          type: pserv
          name: redis
          property: internalUrl
      - key: CELERY_RESULT_BACKEND
        fromService:
          type: pserv
          name: redis
          property: internalUrl
      
      - key: MASTER_API_KEY
        sync: false
      - key: TESSERACT_OCR_ENABLED
        value: true
      - key: LOG_LEVEL
        value: INFO
      - key: DEBUG
        value: false